<html>
  <head>
    <meta charset="utf-8">
    <title>RageTube</title>
  <style type="text/css">
body {
  font-family: Arial, sans serif;
  background-color: black;
}

.selected {
  border:1px solid black;
  font-weight: bold;
}

.unselected {
  border: none;
  font-weight: normal;
}

#mainBlock {
  width: 810px;
  height: 450px;
  border-radius: 2px;
  padding: 5px;
  margin-left: auto;
  margin-right: auto;
  background-color: #A0B0BF;
}

#inputBlock {
  margin-bottom: 10px;
}

#urlInput {
  width: 300px;
}

#playlistBlock {
  width:350px;
  height: 390px;
  float:left;
  overflow: auto;
  margin-right: 15px;
  border: 1px solid black;
}

#videoBlock {
  width: 450px;
  float:left;
}

#controlsBlock {
  text-align: center;
  float: left;
  margin-left: 180px;
  margin-top: 5px;
  font-size: 36px;
}
  </style>
  <script src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
  <script src="jsonp.js"></script>
  <script>
var playlist = [];
var currentSong = 0;
var waitingForSong = false;
var youtubePlayer;

// Loads a new playlist based on the URL entered
// and starts playing it.
function onUrlEnter() {
  // Reset data and UI
  playlist.length = 0;
  currentSong = 0;
  waitingForSong = false;
  document.getElementById('playlistTable').innerHTML = '';

  // Use Dapper to scrape the page and get JSON of song info
  document.getElementById('statusBlock').innerHTML = 'Loading...';
  var dappUrl = 'http://open.dapper.net/transform.php';
  var params = {
    'dappName': 'RagePlaylist',
    'transformer': 'JSON',
    'applyToUrl': document.getElementById('urlInput').value
  }
  JSONP.get(dappUrl, params, 'extraArg_callbackFunctionWrapper', function(json){
    var status = json.dapper.status;
    if (status == 'OK') {
      // Populate playlist object based on what the Dapp found in the page
      var groups = json.groups.songinfo;
      for (var i = 0; i < groups.length; i++) {
        var song = {};
        song.artist = groups[i].artist[0].value.split('-')[0];
        song.title = groups[i].song[0].value;
        playlist.push(song);
      }
      document.getElementById('statusBlock').innerHTML = '';

      // Create table of songs in playlist
      var playlistTable = document.getElementById('playlistTable');
      for (var i = 0; i < playlist.length; i++) {
        var song = playlist[i];
        var songRow = document.createElement('tr');
        songRow.id = 'song' + i;
        var artistCol = document.createElement('td');
        artistCol.innerHTML = song.artist;
        var titleCol = document.createElement('td');
        titleCol.innerHTML = song.title;
        songRow.appendChild(artistCol);
        songRow.appendChild(titleCol);
        playlistTable.appendChild(songRow);
      }
      document.getElementById('playlistBlock').style.display = 'block';
      document.getElementById('controlsBlock').style.display = 'block';
      playNext();
    } else {
      alert('Sorry, we couldn\'t load that playlist for some reason.');
    }
  });
}

// Plays the next song and queues the one after that.
function playNext() {
  // If we've already found the youtube Id, play it
  // Otherwise, search for the song and play it once found
  if (playlist[currentSong].youtubeId) {

    waitingForSong = false;
    var youtubeId = playlist[currentSong].youtubeId;

    // If we haven't embedded the youtube player SWF yet, do it now
    // Otherwise, use the JS API to load the video
    if (!youtubePlayer) {
      var params = {allowScriptAccess: 'always'};
      var atts = {id: 'youtubeplayer'};
      swfobject.embedSWF('http://www.youtube.com/v/' + youtubeId + '?autoplay=1&enablejsapi=1&playerapiid=ytplayer',
                       'videoBlock', '425', '356', '8', null, null, params, atts);
    } else {
      youtubePlayer.loadVideoById(youtubeId);
    }

    // Toggle CSS so current song shows as playing
    for (var i = 0; i < playlist.length; i++) {
      document.getElementById('song' + i).className = 'unselected';
    }
    document.getElementById('song' + currentSong).className = 'selected';

  } else {
    waitingForSong = true;
    searchForSong(currentSong);
  }

  // Queue next song
  if (!playlist[currentSong + 1].youtubeId) {
    searchForSong(currentSong + 1);
  }
}

// Searches for the song, and plays it if needed
function searchForSong(songNum) {
  // Use the Youtube data API to find the song
  var song = playlist[songNum];
  var query = song.artist + ' ' + song.title;
  var searchUrl = 'http://gdata.youtube.com/feeds/api/videos';
  var params = {
    'v': '2',
    'alt': 'jsonc',
    'format': '5',
    'q': query
  }
  JSONP.get(searchUrl, params, null, function(json) {
    song.results = json.data.items;
    song.youtubeId = json.data.items[0].id;
    // If the player is waiting for this song info, play it now
    if (waitingForSong) {
      playNext();
    }
  });
}

// Called when the embedded player is available to be scripted
function onYouTubePlayerReady(playerId) {
  // Save player to global variable and add event listener
  youtubePlayer = document.getElementById('youtubeplayer');
  youtubePlayer.addEventListener('onStateChange', 'onYouTubePlayerStateChange');
}

// Called whenever the embedded player changes state.
function onYouTubePlayerStateChange(newState) {
  // If the video has reached the end, then play the next song
  if (newState == 0) {
    currentSong++;
    playNext();
  }
}
  </script>
  </head>
<body>
<div id="mainBlock">
<div id="inputBlock">
<label>Enter URL to Rage playlist:
  <input id="urlInput" type="text"
  value="http://www.abc.net.au/rage/archive/s3014896.htm">
  <button onclick="onUrlEnter()">Load</button>
  <span id="statusBlock"></span>
</label>
</div>

<div id="playlistBlock" style="display:none">
  <table>
    <tbody id="playlistTable">
    </tbody>
 </table>
</div>

<div id="videoBlock">
</div>

<div id="controlsBlock" style="display:none">
<button onclick="currentSong++; playNext()">NEXT</button>
</div>

</div>

 </body>
</html>
