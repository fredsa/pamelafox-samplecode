<html>
  <head>
    <meta charset="utf-8">
    <title>RageTube</title>
  <style type="text/css">
body {
  font-family: Arial, sans serif;
  background-color: black;
}

.selected {
  border:1px solid black;
  font-weight: bold;
}

.unselected {
  border: none;
  font-weight: normal;
}

.centered {
  width: 810px;
  border-radius: 2px;
  padding: 5px;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 10px;
  background-color: #A0B0BF;
}

#mainBlock {
  height: 460px;
}

#inputBlock {
  margin-bottom: 10px;
}

#urlInput {
  width: 300px;
}

#playlistBlock {
  width:350px;
  height: 405px;
  float:left;
  overflow: auto;
  margin-right: 15px;
  border: 1px solid black;
  cursor: pointer;
}

#videoBlock {
  width: 450px;
  float:left;
}

#controlsBlock {
  text-align: center;
  float: left;
  margin-left: 180px;
  margin-top: 5px;
}

#controlsBlock button {
  font-size: larger;
}

#footerBlock {
  text-align: center;
  font-size: smaller;
}

.Yay {
  color: green;
}
.Meh {
  color: orange;
}
.Nay {
  color: red;
}
  </style>
  <script src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
  <script src="jsonp.js"></script>
  <script src="liker.js"></script>
  <script>
var playlistUrl = null;
var playlist = [];
var currentSong = 0;
var waitingForSong = false;
var youtubePlayer;


// Loads a new playlist based on the URL entered
// and starts playing it.
function onUrlEnter() {
  // Reset data and UI
  playlist.length = 0;
  currentSong = 0;
  waitingForSong = false;
  document.getElementById('playlistTable').innerHTML = '';

  playlistUrl = document.getElementById('urlInput').value;
  window.location.hash = '?url=' + playlistUrl;

  // Use Dapper to scrape the page and get JSON of song info
  document.getElementById('statusBlock').innerHTML = 'Loading...';

  if (playlistUrl.indexOf('playlist/') > -1) {
    dappName = 'RageOldPlaylists';
  } else {
    dappName = 'RagePlaylist';
  }

  var dappUrl = 'http://open.dapper.net/transform.php';
  var params = {
    'dappName': dappName,
    'transformer': 'JSON',
    'applyToUrl': playlistUrl
  }
  JSONP.get(dappUrl, params, 'extraArg_callbackFunctionWrapper', function(json){
    var status = json.dapper.status;
    if (status == 'OK') {
      // Populate playlist object based on what the Dapp found in the page
      var groups = json.groups.songinfo;
      for (var i = 0; i < groups.length; i++) {
        var song = {};
        if (json.dapper.dappName == 'RageOldPlaylists') {
          var allinfo = groups[i].allinfo[0].value;
          var splitinfo = allinfo.split(' - ');
          if (splitinfo.length == 1) continue;
          // Remove numbers before song titles for countdowns
          song.title = splitinfo[0].replace(/^[0-9]*\./, '');
          // Remove labels after titles (without removing featuring)
          song.artist = splitinfo[1].replace(/[A-Z][a-z]+/, '').replace(/EMI|BMG/, '');
        } else {
          song.artist = groups[i].artist[0].value.split(' - ')[0];
          song.title = groups[i].song[0].value;
        }
        song.id = (song.artist + '-' + song.title).toLowerCase().replace(' ', '');
        playlist.push(song);
      }
      // Create table of songs in playlist
      for (var i = 0; i < playlist.length; i++) {
        addSongRow(i);
      }
      document.getElementById('statusBlock').innerHTML = '';
      document.getElementById('playlistBlock').style.display = 'block';
      document.getElementById('controlsBlock').style.display = 'block';
      playNext();
    } else {
      alert('Sorry, we couldn\'t load that playlist for some reason.');
    }
  });
}

function addSongRow(songNum) {
  var song = playlist[songNum];

  var songRow = document.createElement('tr');
  songRow.id = 'song' + songNum;
  var artistCol = document.createElement('td');
  artistCol.innerHTML = song.artist;
  var titleCol = document.createElement('td');
  titleCol.innerHTML = song.title;
  var likerCol = document.createElement('td');
  likerCol.style.width = '30px';
  likerCol.appendChild(LIKER.createLikerMini(song.id));

  songRow.appendChild(artistCol);
  songRow.appendChild(titleCol);
  songRow.appendChild(likerCol);
  songRow.onclick = function() {
    currentSong = songNum;
    playNext();
  };

  var playlistTable = document.getElementById('playlistTable');
  playlistTable.appendChild(songRow);
}

// Plays the next song and queues the one after that.
function playNext() {
  // If we've already found the youtube Id, play it
  // Otherwise, search for the song and play it once found
  var song = playlist[currentSong];
  if (song.youtubeId) {

    waitingForSong = false;

    // If we haven't embedded the youtube player SWF yet, do it now
    // Otherwise, use the JS API to load the video
    if (!youtubePlayer) {
      var params = {allowScriptAccess: 'always', allowFullScreen: 'true'};
      var atts = {id: 'youtubeplayer'};
      swfobject.embedSWF('http://www.youtube.com/v/' + song.youtubeId +
        '?autoplay=1&showsearch=0&rel=0&fs=1&enablejsapi=1&playerapiid=ytplayer',
        'videoBlock', '425', '356', '8', null, null, params, atts);
    } else {
      youtubePlayer.loadVideoById(song.youtubeId);
    }

    document.getElementById('likerBlock').innerHTML = '';
    document.getElementById('likerBlock').appendChild(LIKER.createLiker(song.id));

    // Toggle CSS so current song shows as playing
    for (var i = 0; i < playlist.length; i++) {
      document.getElementById('song' + i).className = 'unselected';
    }
    var songBlock = document.getElementById('song' + currentSong);
    songBlock.className = 'selected';

    document.getElementById('playlistBlock').scrollTop = songBlock.offsetTop;
  } else {
    waitingForSong = true;
    searchForSong(currentSong);
  }

  // Queue next song
  if (!playlist[currentSong + 1].youtubeId) {
    searchForSong(currentSong + 1);
  }
}

// Searches for the song, and plays it if needed
function searchForSong(songNum) {
  // Use the Youtube data API to find the song
  var song = playlist[songNum];
  var query = song.artist + ' ' + song.title;
  var searchUrl = 'http://gdata.youtube.com/feeds/api/videos';
  var params = {
    'v': '2',
    'alt': 'jsonc',
    'format': '5',
    'q': query
  }
  JSONP.get(searchUrl, params, null, function(json) {
    song.results = json.data.items;
    song.youtubeId = json.data.items[0].id;
    // If the player is waiting for this song info, play it now
    if (waitingForSong) {
      playNext();
    }
  });
}

// Called when the embedded player is available to be scripted
function onYouTubePlayerReady(playerId) {
  // Save player to global variable and add event listener
  youtubePlayer = document.getElementById('youtubeplayer');
  youtubePlayer.addEventListener('onStateChange', 'onYouTubePlayerStateChange');
}

// Called whenever the embedded player changes state.
function onYouTubePlayerStateChange(newState) {
  // If the video has reached the end, then play the next song
  if (newState == 0) {
    currentSong++;
    playNext();
  }
}
  </script>
  </head>
<body>
<div class="centered" id="mainBlock">
<div id="inputBlock">
<label>Enter URL to Rage playlist:
  <input id="urlInput" type="text"
  value="http://www.abc.net.au/rage/archive/s3014896.htm">
  <button onclick="onUrlEnter()">Load</button>
  <span id="statusBlock"></span>
</label>
</div>

<div id="playlistBlock" style="display:none">
  <table>
    <tbody id="playlistTable">
    </tbody>
 </table>
</div>

<div id="videoBlock">
</div>

<div id="controlsBlock" style="display:none">
  <div id="likerBlock" style="margin-bottom: 7px"></div>
  <button onclick="currentSong++; playNext()">NEXT</button>
</div>

</div>

<div class="centered" id="footerBlock">
Powered by <a href="http://open.dapper.net">Dapper</a>, <a
  href="http://code.google.com/apis/youtube/player_parameters.html">Youtube
  Player API</a> and <a
  href="http://code.google.com/apis/youtube/2.0/developers_guide_jsonc.html">Youtube
  Data API JSON-C</a>.
  <br><br>
<a
  href="http://code.google.com/p/pamelafox-samplecode/issues/entry?template=RageTube%20Issue">Report
an Issue</a>
|
<a
  href="http://code.google.com/p/pamelafox-samplecode/issues/list?can=2&q=project-RageTube">See
  all Issues</a>

</div>

<script>
function getHashParam(name) {
  var regexS = "[\\?&]" + name + "=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(window.location.hash);
  return (results === null ? "" : results[1]);
}

var url = getHashParam('url');
if (url) {
  document.getElementById('urlInput').value = url;
  onUrlEnter();
}
</script>
 </body>
</html>
